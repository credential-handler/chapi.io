<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">

<title>CHAPI is the Credential Handler API | an open-source solution for communicating Verifiable Credentials on the Web</title>
<meta property="og:title" content="CHAPI is the Credential Handler API" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="an open-source solution for communicating Verifiable Credentials on the Web" />
<meta property="og:description" content="an open-source solution for communicating Verifiable Credentials on the Web" />
<link rel="canonical" href="https://chapi.io/" />
<meta property="og:url" content="https://chapi.io/" />
<meta property="og:site_name" content="CHAPI is the Credential Handler API" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="CHAPI is the Credential Handler API" />
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","description":"an open-source solution for communicating Verifiable Credentials on the Web","headline":"CHAPI is the Credential Handler API","name":"CHAPI is the Credential Handler API","url":"https://chapi.io/"}</script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" as="style" type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/prismjs@1/themes/prism.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.2/dist/semantic.min.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/style.css">
  </head>
  <body>
    <a id="skip-to-content" href="#content">Skip to the content.</a>

    <!-- Sidebar Menu -->
    <div class="ui vertical inverted right sidebar menu">
      <a class="item" href="/developers/issuers">VC Issuers</a>
      <a class="item" href="/developers/wallets">Digital Wallets</a>
      <a class="item" href="/developers/verifiers">VC Verifiers</a>
      <span class="item">
        <a class="ui basic inverted button" href="https://vcplayground.org/">Try the Playground!</a>
      </span>
    </div>

    <div class="pusher">
    <header class="ui top inverted fixed menu" role="banner">
      <a class="ui header item" href=https://chapi.io/>
        chapi.io
        <span class="desktop only">&nbsp; | Credential Handler API</span>
      </a>
      <span class="item">
        <a class="ui basic inverted button" href="https://vcplayground.org/">Try the Playground!</a>
      </span>
      <div class="right menu">
        <a class="toc icon item"><i class="sidebar icon"></i></a>
        <a class="item" href="/developers/issuers">VC Issuers</a>
        <a class="item" href="/developers/wallets">Digital Wallets</a>
        <a class="item" href="/developers/verifiers">VC Verifiers</a>
      </div>
    </header>
    

    <main id="content" class="main-content" role="main">
      <h2 id="handling-a-vc-api-exchange-in-a-web-wallet" tabindex="-1">Handling a VC API Exchange in a Web Wallet</h2>
<figure>
<blockquote>
<p>A VC API workflow defines a particular set of steps for exchanging verifiable
credentials between two parties across a trust boundary. Each step can involve
the issuance, verification, transmission, or presentation of verifiable
credentials.</p>
</blockquote>
<figcaption>
  <cite>from <a href="https://w3c-ccg.github.io/vc-api/#workflows-and-exchanges">VC API Workflows & Exchanges</a></cite>
</figcaption>
</figure>
<p>A VC API workflow interaction begins with <em>either</em> a CHAPI event or an
interaction URL via a QR code (or similar user initiated transfer experience).</p>
<p>The CHAPI event will provide a complete protocols object similar to the
following:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"protocols"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"vcapi"</span><span class="token operator">:</span> <span class="token string">"https://vcapi.example.com/workflows/abc/exchanges/123"</span><span class="token punctuation">,</span>
    <span class="token property">"OID4VCI"</span><span class="token operator">:</span> <span class="token string">"openid-credential-offer://?..."</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Alternatively, a QR code can be used to provide a URL which when dereferenced
will result in either a <code>protocols</code> (object as above) or an HTML fallback page
to allow the user to continue otherwise.</p>
<p>To retrieve a <code>protocols</code> object from an <em>interaction URL</em>, the Wallet must send
an HTTP GET request including an explicit <code>Accept: application/json</code> request
header--which results in the same JSON object as above:</p>
<pre class="language-http"><code class="language-http">GET /workflows/abc/exchanges/123/protocols
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">vcapi.example.com</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>

{
  "protocols": {
    "vcapi": "https://vcapi.example.com/workflows/abc/exchanges/123",
    "OID4VCI": "openid-credential-offer://?..."
  }
}</code></pre>
<p>Once a VC API exchange URL is acquisitioned from <code>protocols.vcapi</code>, a POST
request is sent with a configuration object (which may be empty) to begin the
exchange:</p>
<pre class="language-http"><code class="language-http">POST /workflows/abc/exchanges/123
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">vcapi.example.com</span></span>

{}</code></pre>
<p>A response will be returned by the exchanger...</p>
<p>If the response object is empty (as above), the exchange is complete and nothing
is requested from nor offered to the exchange client.</p>
<p>If, however, the object includes <code>verifiablePresentationRequest</code>, then the
exchange is not yet complete and some <em>additional information is requested</em>, as
specified by the contents of the associated verifiable presentation request.</p>
<blockquote>
<p>Read more about possible values in the
<a href="https://w3c-ccg.github.io/vp-request-spec/#overview">Verifiable Presentation Requests</a>
specification.</p>
</blockquote>
<p>For example:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"verifiablePresentationRequest"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"QueryByExample"</span><span class="token punctuation">,</span>
      <span class="token property">"credentialQuery"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token property">"reason"</span><span class="token operator">:</span> <span class="token string">"We require proof of residency to onboard you."</span><span class="token punctuation">,</span>
        <span class="token property">"example"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"@context"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"https://www.w3.org/ns/credentials/v2"</span><span class="token punctuation">,</span>
            <span class="token string">"https://w3id.org/citizenship/v1"</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"PermanentResidentCard"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>If the object includes <code>verifiablePresentation</code>, then some <em>information is
offered</em>, such as verifiable credentials issued to the holder operating the
exchange client (i.e. the Wallet) or verifiable credentials with information
about the exchange server's operator based on the exchange client's request.</p>
<p>For example:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"verifiablePresentation"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"@context"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"https://www.w3.org/ns/credentials/v2"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"VerifiablePresentation"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"verifiableCredential"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token property">"@context"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"https://www.w3.org/ns/credentials/v2"</span><span class="token punctuation">,</span>
        <span class="token string">"https://w3id.org/citizenship/v1"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"VerifiableCredential"</span><span class="token punctuation">,</span> <span class="token string">"PermanentResidentCard"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token comment">// additional properties...</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>If the object includes <code>redirectUrl</code>, the <em>exchange is complete</em> and the
workflow service recommends that the client sent the user to another place to
continue the interaction.</p>
<p>For example:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"redirectUrl"</span><span class="token operator">:</span> <span class="token string">"https://vcapi.example.com/go-here-next"</span>
<span class="token punctuation">}</span></code></pre>
<p>Many Verifiable Credential use cases can be implemented using these basic
primitives. Either party to an exchange is capable of requesting Verifiable
Presentations and of providing one or more Verifiable Credentials that might be
necessary to establish trust and/or gain authorization capabilities, and either
party is capable of presenting credentials that they hold or that they have
issued. Specific workflows can be configured to expect specific presentations
and credentials and to reject deviations from the expected flow of information.</p>
<p>When a workflow service determines that a particular message is not acceptable,
it raises an error by responding with a <code>4xx</code> HTTP status message and a JSON
object that expresses information about the error.</p>
<p>Below is an example of a typical exchange:</p>
<pre class="mermaid attached">sequenceDiagram&#10;    participant H as Holder&#10;    participant W as Holder Coordinator (Wallet)&#10;    participant I as Issuer/Verifier Coordinator&#10;    autonumber&#10;    Note right of H: Start exchange&#10;    W-&gt;&gt;I: Initiate&#10;    Note right of W: POST /workflows/abc/exchanges/123 &mdash; HTTP request to start exchange (e.g., send credentials, get credentials)&#10;    I-&gt;&gt;W: Verifiable Presentation Request (VPR)&#10;    Note left of I: VPR includes method of interaction, for purposes of exchange&#10;    W-&gt;&gt;I: Verifiable Presentation (VP)&#10;    Note right of W: POST /workflows/abc/exchanges/123 &mdash; sent via interaction mechanism to meet requirements of exchange&#10;    I-&gt;&gt;W: Verifiable Presentation&#10;    Note left of I: VP includes result of exchange (e.g., VCs), or VPR with new interaction request, or error description&#10;</pre>
<p>The exchange client (Wallet) code for a flow like the above may look similar to
the following:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> receivedExchangeUrl <span class="token operator">=</span> <span class="token string">'https://vcapi.example.com/workflows/abc/exchanges/123'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>receivedExchangeUrl<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span>
  <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">checkResponse</span><span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">'verifiablePresentationRequest'</span> <span class="token keyword">in</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// use the information in the Verifiable Presentation Request to find a</span>
    <span class="token comment">// credential that fulfills the request, then send a Verifiable</span>
    <span class="token comment">// Presentation a message back to the exchange endpoint</span>
    <span class="token comment">// Verifiable Presentation Request</span>
    <span class="token keyword">const</span> verifiablePresentation <span class="token operator">=</span> <span class="token function">findCredentialAndCreatePresentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>receivedExchangeUrl<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>verifiablePresentation<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">'verifiablePresentation'</span> <span class="token keyword">in</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// the Wallet has received a Verifiable Presentation containing one or more</span>
    <span class="token comment">// Verifiable Credentials--use them per your use case</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">'redirectUrl'</span> <span class="token keyword">in</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// take the user to the new location</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>


      <footer class="site-footer">
        <div class="site-footer-credits">This site content is open-source
          licensed by contributors under the <a href="/license">BSD 3-Clause</a>.
        </div>
        <div class="site-footer-credits">
          Please contribute at <a href="https://github.com/credential-handler/chapi.io"><i class="github link icon"></i>credential-handler/chapi.io</a>
        </div>
      </footer>
    </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.2/dist/semantic.min.js"></script>
    <script>
      // create sidebar and attach to menu open
      $('.ui.sidebar')
        .sidebar('attach events', '.toc.item');
    </script>
    <script type="module" async>
    import mermaid from 'https://unpkg.com/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.run({
      querySelector: '.mermaid',
      postRenderCallback: (id) => {
        const selector = '#'.concat(id);
        const chart = document.getElementById(id);
        chart.setAttribute('height', chart.getBoundingClientRect().height);
        chart.style.backgroundColor = 'inherit';
        const zoomable = svgPanZoom(selector, {
          zoomEnabled: true,
          controlIconsEnabled: true,
          fit: true,
          center: true
        });
        console.log(zoomable);

        const fullscreenIcon = chart.parentElement.previousElementSibling;
        const pre = chart.parentElement.parentElement;

        const observer = new ResizeObserver(() => zoomable.resize().reset());
        observer.observe(pre);

        const classes = fullscreenIcon.querySelector('i').classList;
        fullscreenIcon.addEventListener('click', (ev) => {
          if (classes.contains('expand')) {
            pre.requestFullscreen().then(() => {
              classes.replace('expand', 'compress');
            });
          } else if (classes.contains('compress')) {
            document.exitFullscreen();
          }
        });

        document.addEventListener('fullscreenchange', (ev) => {
          if (!document.fullscreenElement) {
            // leaving fullscreen, so scroll to the element that was open
            ev.target.scrollIntoView();
            classes.replace('compress', 'expand');
          }
        });
      }
    });
  </script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3/dist/svg-pan-zoom.min.js"></script>
  </body>
</html>
